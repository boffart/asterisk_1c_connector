## Системные требования
```
Asterisk 13
PHP 7 с поддержкой Curl
Настроенный AMI
1C 8.3.12 (режим совместимости с 8.3.10)
Apache, для публикации 1С по протоколу http
Для работы используется облачный сервис 1cDialog.com
-- При необходимости возможно вместо 1cDialog.com развернуть сервисы локально, но для этого потребуется обратиться к документации Платформы 1С. 

```

## Установка и настройка 1С

1. Качаем и устанавливаем Apache 2.2
2. Качаем и устанавливаем 1С:Предприятие 8.3.12
  * Скачать можно тут https://1c-dn.com
  * (опыты ставить можно на версии для обучения программированию)
  * у версии для обучения есть ограничение на 1 рабочее место. 
3. Запускаем 1С УНФ "от имени" Администратора  в режиме "Конфигуратор" !!!
4. Переходим в меню "Конфигурация" - "Расширения конфигурации"
5. В окне управления расширениями конфигурации следует выполнить действие "Действия" - "Конфигурация" - "Загрузить конфигурацию из файлов"
  * Для загрузки следует выбрать каталог 1c текущего репозитория
6. В списке расширений появится новое, с именем "AsteriskConnector"
7. Выполните действие "Конфигурация" - "Обновить конфигурацию базы данных"
8. Необходимо опубликовать http сервисы информационной базы
  * "**Администрирование**" - "**Публикация на web сервере**"
  * Указываем **имя** публикации "**base**"
  * Веб-сервер выбираем Apache 2.2
  * Указываем каталог, где будут храниться файлы публикации 
  * На вкладке "**http сервисы**" выберем "**unf**"
  * Осталось только выполнить действие "**Опубликовать**"
9. Выполните действие «Сервис» - «Параметры», вкладка «Запуск 1С:Предприятие». 
  * В поле «Параметры запуска» укажите строку «ЗапуститьОбновлениеИнформационнойБазы»  
  * Открываем информационную базу в режиме "1C:Предприятие"
  * Будет выполнено заполнение необходимых для работы данных
  * В поле «Параметры запуска» ОЧИСТИТЕ данные
11. Необходимо всем пользователям телефонии назначить роль "МИКО: Интеграция с телефонией"
  * В справочник "Профили групп доступа" следует добавить соответствующий элемент
  * В карточке пользователя, на вкладке "Права доступа" следует установить галку у роли "МИКО: Интеграция с телефонией"
12. Необходимо подключить базу данных 1с к подсистеме взаимодействий
  * Перейдите в меню "Все функции", в режиме работы 1С:Предприятие  
  * Раздел "Стандартные" - "Управление подсистемой взаимодействия"
  * Выполните подключение базы к подсистеме
13. Перейдите в раздел "МИКО: Телефония. Базовые функции" - "Настройки телефонии"
  * Выполните действие "Создать интеграцию"
  * Выполните действие "Заполнить пользователей"
  * Установите флаги использования телефонии и подсистемы взаимодействий для пользователей. 
  * В карточке пользователей следует назначит внутренний номер телефона
14. Создайте нового пользователя 1С, к примеру с именем web - это пользователь, от имени которого будет подключаться телефонная станция  
  
## Запуск служб на ПК с PBX
1. Скопируйте скрипты из каталога php в рабочую директорию на АТС
2. Пропишите параметры подключения к AMI и к 1С в файле settings.php
3. Для работы интеграции достаточно запустить вручную "php -f safe_listner.php"
4. Добавьте в cron запуск скрипта "safe_listner.php" - он будет при необходимости перезапускать "worker_1c_ami_listener.php"  
5. Если возникнут ошибки, они будут отражены в syslog